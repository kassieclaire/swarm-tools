{"id":"opencode-swarm-monorepo-lf2p4u-mjd7jzq0gcb","title":"Socket mode should self-heal on port conflicts","description":"## Symptom\n`[swarm-mail] Socket mode failed, falling back to embedded PGLite: Failed to listen at 127.0.0.1`\n\nBut it doesn't actually fall back gracefully - it errors out.\n\n## Expected\nIf socket is busy, should:\n1. Try to connect to existing daemon first (maybe it's already running)\n2. If that fails, fall back to embedded mode silently\n3. Never require manual `pkill` intervention\n\n## Current Behavior\nThrows error, requires manual cleanup of stale processes.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-19T18:33:44.856Z","updated_at":"2025-12-19T18:36:56.415Z","closed_at":"2025-12-19T18:36:56.415Z","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd7nzj52z9","title":"Fix daemon socket connection - weird default port + self-healing","description":"## Problems\n\n1. **Default port 5433 conflicts** - Too close to Postgres default (5432), likely to conflict\n2. **No self-healing** - If daemon dies or port is busy, errors out instead of recovering\n3. **Race condition** - Multiple tool calls can try to start daemon simultaneously\n\n## Required Fixes\n\n### 1. Use weird default port\nChange from 5433 to something like **15433** or **54330** - unlikely to conflict with anything.\n\n### 2. Self-healing connection logic\nCurrent flow:\n```\nisDaemonRunning (PID check) → startDaemon → healthCheck → connect\n```\n\nShould be:\n```\n1. Try healthCheck first (maybe daemon already running)\n2. If healthy → connect\n3. If not healthy → check PID, kill stale if needed\n4. Try startDaemon with retry/backoff\n5. If port busy, try connecting (another process may have started it)\n6. Only error after all recovery attempts fail\n```\n\n### 3. Proper locking\nUse file lock or atomic PID file to prevent race conditions between multiple processes trying to start daemon.\n\n## Files\n- `packages/swarm-mail/src/daemon.ts` - startDaemon, isDaemonRunning, healthCheck\n- `packages/swarm-mail/src/pglite.ts` - createDaemonAdapter orchestration\n- `packages/swarm-mail/src/daemon.test.ts` - tests for all scenarios\n\n## Tests Needed\n- Port already in use by another process → self-heal\n- Stale PID file (process died) → clean up and restart\n- Race condition (two processes start simultaneously) → one wins, other connects\n- Daemon crashes mid-session → reconnect transparently","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-19T18:36:51.233Z","updated_at":"2025-12-19T18:51:43.481Z","closed_at":"2025-12-19T18:51:43.481Z","dependencies":[],"labels":[],"comments":[]}
