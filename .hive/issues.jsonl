{"id":"opencode-swarm-monorepo-lf2p4u-mjcz99b8tku","title":"PGlite Hardening Phase 2: Additional Safety Measures","description":"## Research Summary\n\nBased on PGlite docs and our current implementation, here are additional hardening opportunities:\n\n### Already Implemented ✅\n1. **WAL Checkpoint** - `checkpoint()` after batch ops\n2. **WAL Health Monitoring** - `checkWalHealth()` with 100MB threshold\n3. **WASM Abort Recovery** - Auto-delete corrupted DB and retry\n4. **Daemon Mode** - Socket adapter for single long-lived process\n5. **Singleton Pattern** - One PGlite instance per database path\n\n### Opportunities for Phase 2\n\n#### 1. Multi-Tab/Multi-Process Leader Election (HIGH VALUE)\nPGlite provides `PGliteWorker` with built-in leader election. Only ONE process owns the database, others proxy through it.\n\n**Current risk:** Multiple swarm agents spawning separate processes each create their own PGlite instance → corruption.\n\n**Solution:** Implement leader election pattern from `@electric-sql/pglite/worker`:\n- Leader owns the PGlite instance\n- Followers proxy queries through leader\n- Auto-election when leader dies\n\n**Files:** New `packages/swarm-mail/src/leader-election.ts`\n\n#### 2. Relaxed Durability Mode (MEDIUM VALUE)\nPGlite's `relaxedDurability: true` option returns query results immediately, flushes to storage async.\n\n**Benefit:** Faster queries, especially with IndexedDB\n**Risk:** Data loss on crash (acceptable for ephemeral coordination data)\n\n**Files:** `pglite.ts` - add option to `PGlite.create()`\n\n#### 3. dumpDataDir/loadDataDir for Backup (MEDIUM VALUE)\nPGlite can dump entire database to tarball and restore from it.\n\n**Use case:** \n- Backup before risky operations\n- Migrate between storage backends\n- Debug production issues locally\n\n**Files:** Add `dumpDatabase()` and `loadDatabase()` to adapter\n\n#### 4. initialMemory Tuning (LOW VALUE)\nPre-allocate WASM memory to avoid pause during growth.\n\n**Current:** PGlite grows memory on demand (causes pause)\n**Improvement:** Set `initialMemory` based on expected database size\n\n**Files:** `pglite.ts` - add option\n\n#### 5. Graceful Shutdown Hook (MEDIUM VALUE)\nEnsure checkpoint runs on process exit.\n\n**Current:** Unclean shutdown leaves WAL uncommitted\n**Improvement:** Register `process.on('exit')` handler to checkpoint\n\n**Files:** `pglite.ts`, `daemon.ts`\n\n#### 6. Connection Timeout/Retry (LOW VALUE)\nSocket adapter should retry on transient failures.\n\n**Files:** `socket-adapter.ts`\n\n### Recommended Priority\n\n1. **Leader Election** - Prevents multi-process corruption (P1)\n2. **Graceful Shutdown** - Ensures clean WAL state (P1)\n3. **Relaxed Durability** - Performance boost (P2)\n4. **Backup/Restore** - Disaster recovery (P2)\n5. **Memory Tuning** - Nice to have (P3)\n6. **Connection Retry** - Nice to have (P3)","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-19T14:41:27.140Z","updated_at":"2025-12-19T14:41:27.140Z","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjczeyk1ku9","title":"Daemon Mode by Default - Multi-Process Safety","description":"Make daemon mode the default for PGlite to prevent multi-process corruption.\n\n## Problem\nPGlite is single-connection only. When multiple swarm workers spawn separate processes, each creates its own PGlite instance pointing to the same database → corruption.\n\n## Solution\nFlip the default: daemon mode ON by default, embedded mode opt-in.\n\n## Changes\n1. **Flip default** - `getSwarmMail()` uses socket mode unless `SWARM_MAIL_SOCKET=false`\n2. **Auto-start daemon** - Already implemented, just needs to be the default path\n3. **Graceful shutdown** - Register `process.on('exit')` to checkpoint before exit\n4. **Update docs** - README explains new default, how to opt-out\n\n## Backward Compatibility\n- `SWARM_MAIL_SOCKET=false` opts out to embedded mode\n- Existing socket mode env vars still work\n- Tests use in-memory mode (unaffected)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-19T14:45:53.137Z","updated_at":"2025-12-19T15:18:13.192Z","closed_at":"2025-12-19T15:18:13.192Z","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjczeykdnqn","title":"Flip default: daemon mode ON, embedded mode opt-out","description":"BLOCKED: pglite-server binary not installed. Pivoting to use PGLiteSocketServer in-process instead.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T14:45:53.149Z","updated_at":"2025-12-19T15:18:10.588Z","closed_at":"2025-12-19T15:18:10.588Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjczeyk1ku9","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjczeykib1i","title":"Add graceful shutdown hook with checkpoint on process exit","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T14:45:53.154Z","updated_at":"2025-12-19T15:18:11.520Z","closed_at":"2025-12-19T15:18:11.520Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjczeyk1ku9","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjczeyknx2r","title":"Update README and docs for new default behavior","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T14:45:53.159Z","updated_at":"2025-12-19T15:18:12.325Z","closed_at":"2025-12-19T15:18:12.325Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjczeyk1ku9","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjczqnskykw","title":"Refactor daemon to use PGLiteSocketServer in-process (no external binary)","description":"## Problem\nCurrent daemon.ts spawns `pglite-server` as external binary - requires global install, adds friction.\n\n## Solution\nUse `PGLiteSocketServer` from `@electric-sql/pglite-socket` directly in-process.\n\n```typescript\nimport { PGLiteSocketServer } from '@electric-sql/pglite-socket'\n\nconst db = await PGlite.create({ dataDir: dbPath })\nconst server = new PGLiteSocketServer({ db, port: 5433 })\nawait server.start()\n```\n\n## Benefits\n- No external binary dependency\n- Faster startup (no process spawn)\n- Cleaner architecture\n- Can share server across tests\n\n## Files\n- `packages/swarm-mail/src/daemon.ts` - Replace spawn() with PGLiteSocketServer\n- `packages/swarm-mail/src/pglite.ts` - Update to use new daemon\n\n## TDD\n1. Write test that PGLiteSocketServer starts and accepts connections\n2. Write test that multiple clients can connect sequentially\n3. Implement","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T14:54:59.060Z","updated_at":"2025-12-19T15:18:08.620Z","closed_at":"2025-12-19T15:18:08.620Z","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjczqspn7m0","title":"Add shared test server for faster test suite","description":"## Problem\nTest suite is slow (~120s timeout). Each test creates new PGlite instance (WASM startup ~500ms each).\n\n## Solution\nCreate shared PGLiteSocketServer for tests:\n\n```typescript\n// test-setup.ts\nlet testServer: PGLiteSocketServer\nlet testDb: PGlite\n\nbeforeAll(async () => {\n  testDb = await PGlite.create() // in-memory\n  testServer = new PGLiteSocketServer({ db: testDb, port: 15432 })\n  await testServer.start()\n})\n\nafterAll(async () => {\n  await testServer.stop()\n  await testDb.close()\n})\n\nbeforeEach(async () => {\n  // Truncate all tables instead of recreating DB\n  await testDb.exec('TRUNCATE agents, messages, reservations, ... CASCADE')\n})\n```\n\n## Expected Speedup\n- Current: 50 tests × 500ms init = 25s+ just in PGlite startup\n- After: 1 init + 50 × ~10ms truncate = ~1s\n- **~20x faster**\n\n## Files\n- New: `packages/swarm-mail/src/test-server.ts`\n- Update: `packages/swarm-mail/src/*.test.ts` to use shared server\n\n## TDD\n1. Write test that shared server handles sequential test connections\n2. Write test that truncate resets state correctly\n3. Migrate one test file, measure speedup\n4. Migrate remaining test files","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T14:55:05.435Z","updated_at":"2025-12-19T15:18:09.586Z","closed_at":"2025-12-19T15:18:09.586Z","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjczzaf28qs","title":"Extract database/data access into separate @swarm/db package","description":"## Problem\n`swarm-mail` is a junk drawer - database adapters, event sourcing, hive, memory, coordination all stuffed together.\n\n## Proposed Package Split\n\n| Package | Responsibility |\n|---------|---------------|\n| `@swarm/db` | PGlite wrapper, socket adapter, daemon, migrations, DatabaseAdapter interface |\n| `@swarm/streams` | Event store, Durable Streams primitives (Effect-TS: Mailbox, Cursor, Lock, Deferred) |\n| `@swarm/hive` | Work item tracking (cells, epics, dependencies, git sync) |\n| `@swarm/memory` | Semantic memory, embeddings, decay, Ollama integration |\n| `@swarm/mail` | Agent coordination (messages, reservations, inbox) |\n| `swarm-mail` | Re-exports all of above (backward compatibility) |\n\n## Benefits\n- Clear boundaries\n- Independent versioning\n- Smaller install footprint (use only what you need)\n- Easier testing (isolated packages)\n- Better for tree-shaking\n\n## Migration Strategy\n1. Create new packages with extracted code\n2. Update swarm-mail to re-export from new packages\n3. Deprecation warnings for direct swarm-mail imports\n4. Eventually make swarm-mail a meta-package\n\n## Future Consideration\nWith socket approach, daemon could own Durable Streams and expose via RPC (reduce round-trips). But that's a separate optimization.","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-19T15:01:41.630Z","updated_at":"2025-12-19T15:01:41.630Z","dependencies":[],"labels":[],"comments":[]}